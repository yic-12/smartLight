/**
 * æ™ºèƒ½ç…§æ˜ç®¡ç†APP - è®¾å¤‡æ§åˆ¶é¡µé¢ (ZDY.ets)
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * 1. æä¾›å•ä¸ªè®¾å¤‡çš„å¼€å…³æ§åˆ¶åŠŸèƒ½
 * 2. æ”¯æŒè®¾å¤‡é€‰æ‹©ï¼Œé€šè¿‡æŒ‰é’®å’Œæ»‘å—åˆ‡æ¢è®¾å¤‡
 * 3. æä¾›æ‰¹é‡æ§åˆ¶åŠŸèƒ½ï¼ˆå…¨éƒ¨å¼€å¯/å…¨éƒ¨å…³é—­ï¼‰
 * 4. æ˜¾ç¤ºè®¾å¤‡çŠ¶æ€å’Œå½“å‰é€‰ä¸­è®¾å¤‡ä¿¡æ¯
 * 5. æ”¯æŒç¡®è®¤å¯¹è¯æ¡†é˜²æ­¢è¯¯æ“ä½œ
 * 6. ä½¿ç”¨5ä¸ªè®¾å¤‡æ¥å£æ§åˆ¶å…¨éƒ¨25ä¸ªè®¾å¤‡
 * 
 * æŠ€æœ¯ç‰¹ç‚¹ï¼š
 * - ä½¿ç”¨HarmonyOS ArkUIæ¡†æ¶
 * - é›†æˆHTTPç½‘ç»œè¯·æ±‚
 * - ä½¿ç”¨AppStorageV2è¿›è¡Œå…¨å±€çŠ¶æ€ç®¡ç†
 * - å“åº”å¼UIè®¾è®¡
 * - å¤šè®¾å¤‡ååŒæ§åˆ¶
 */

// å¯¼å…¥HarmonyOS ArkUIçš„AppStorageV2æ¨¡å—
import { AppStorageV2 } from "@kit.ArkUI";
// å¯¼å…¥æ•°æ®æ¨¡å‹
import { LightDevice, ColorRGB } from '../model/DataModel';
// å¯¼å…¥è®¾å¤‡æ§åˆ¶æ•°æ®
import { deviceControls, turn } from '../utils/device'
// å¯¼å…¥HTTPå·¥å…·ç±»
import { HttpUtil } from "../inter/HttpUtil";

// ==================== æ„å»ºå™¨å‡½æ•° ====================

/**
 * ZDYBuilderæ„å»ºå™¨å‡½æ•°
 * 
 * @Builderè£…é¥°å™¨ï¼š
 * - ç”¨äºåˆ›å»ºå¯é‡ç”¨çš„UIæ„å»ºå‡½æ•°
 * - å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹è°ƒç”¨ï¼Œæé«˜ä»£ç å¤ç”¨æ€§
 * - æ”¯æŒå‚æ•°ä¼ é€’ï¼Œå®ç°åŠ¨æ€UIæ„å»º
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - ç”¨äºåœ¨å¯¼èˆªç³»ç»Ÿä¸­åˆ›å»ºZDYç»„ä»¶å®ä¾‹
 * - æä¾›ç»Ÿä¸€çš„ZDYç»„ä»¶åˆ›å»ºå…¥å£
 */
@Builder
export function ZDYBuilder() {
  ZDY();
}

// ==================== ä¸»ç»„ä»¶å®šä¹‰ ====================

/**
 * ZDYç»„ä»¶ - è®¾å¤‡æ§åˆ¶ä¸»ç»„ä»¶
 * 
 * @Componentè£…é¥°å™¨ï¼š
 * - æ ‡è¯†è¿™æ˜¯ä¸€ä¸ªArkUIè‡ªå®šä¹‰ç»„ä»¶
 * - å¯ä»¥ä½¿ç”¨build()æ–¹æ³•æ„å»ºUI
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - æä¾›è®¾å¤‡æ§åˆ¶çš„å®Œæ•´åŠŸèƒ½
 * - æ”¯æŒå•ä¸ªè®¾å¤‡æ§åˆ¶å’Œæ‰¹é‡æ§åˆ¶
 * - æ˜¾ç¤ºè®¾å¤‡çŠ¶æ€å’Œæ“ä½œåé¦ˆ
 */
@Component
export struct ZDY {
  
  // ==================== å¯¼èˆªå’Œç½‘ç»œé…ç½® ====================
  
  /**
   * å¯¼èˆªè·¯å¾„æ ˆ
   * 
   * AppStorageV2.connect()è¯´æ˜ï¼š
   * - å°†å¯¼èˆªæ ˆè¿æ¥åˆ°åº”ç”¨çº§åˆ«çš„å­˜å‚¨
   * - ç¡®ä¿å¯¼èˆªçŠ¶æ€åœ¨æ•´ä¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸä¸­ä¿æŒ
   * - æ”¯æŒå¤šé¡µé¢é—´çš„çŠ¶æ€å…±äº«
   */
  pathStack: NavPathStack = AppStorageV2.connect(NavPathStack, 'navStack', () => new NavPathStack())!;

  // ==================== ç»„ä»¶çŠ¶æ€ç®¡ç† ====================
  
  /**
   * å½“å‰é€‰ä¸­çš„è®¾å¤‡ID
   * @Stateè£…é¥°å™¨è¡¨ç¤ºè¿™æ˜¯å“åº”å¼çŠ¶æ€å˜é‡
   */
  @State selectedDevice: string = ""
  
  /**
   * è®¾å¤‡åˆ—è¡¨æ•°æ®
   * ä»deviceControlså¯¼å…¥çš„æ‰€æœ‰25ä¸ªè®¾å¤‡
   */
  @State deviceList: LightDevice[] = []
  
  /**
   * è®¾å¤‡åˆ—è¡¨æ•°æ®ï¼ˆæ‰¹é‡æ§åˆ¶ç”¨ï¼‰
   * ä»turnå¯¼å…¥çš„5ä¸ªè®¾å¤‡ï¼Œç”¨äºæ§åˆ¶å…¨éƒ¨25ä¸ªè®¾å¤‡
   */
  @State deviceList1: LightDevice[] = []
  
  /**
   * è®¾å¤‡å¼€å…³çŠ¶æ€æ˜ å°„
   * å­˜å‚¨æ‰€æœ‰25ä¸ªè®¾å¤‡çš„å¼€å…³çŠ¶æ€
   */
  @State deviceStatus: Map<string, boolean> = new Map()
  
  /**
   * è®¾å¤‡å¼€å…³çŠ¶æ€æ˜ å°„ï¼ˆæ‰¹é‡æ§åˆ¶ç”¨ï¼‰
   * å­˜å‚¨5ä¸ªæ§åˆ¶è®¾å¤‡çš„å¼€å…³çŠ¶æ€
   */
  @State deviceStatus1: Map<string, boolean> = new Map()

  // ==================== ç½‘ç»œæ¥å£é…ç½® ====================
  
  /**
   * æœåŠ¡å™¨åŸºç¡€URLåœ°å€
   * æ”¯æŒä¸¤ç§ç½‘ç»œç¯å¢ƒï¼š
   * - å±€åŸŸç½‘ï¼šhttp://192.168.2.170:8081
   * - æ ¡å›­ç½‘ï¼šhttp://10.214.166.140:8081
   * 
   * å½“å‰ä½¿ç”¨æ ¡å›­ç½‘åœ°å€ï¼Œå¦‚éœ€åˆ‡æ¢ç½‘ç»œç¯å¢ƒï¼Œè¯·ä¿®æ”¹æ­¤URL
   */
  URL: string = "http://10.214.166.140:8081" // æ ¡å›­ç½‘åœ°å€
  
  /**
   * POSTè¯·æ±‚çš„APIè·¯å¾„
   * ç”¨äºæ§åˆ¶è®¾å¤‡å¼€å…³çŠ¶æ€
   */
  url2: string = '/SmartHome/ShenDaRest/controlLight'

  // ==================== é»˜è®¤æ§åˆ¶å‚æ•° ====================
  
  /**
   * é»˜è®¤äº®åº¦å€¼
   * èŒƒå›´ï¼š0-100ï¼Œè¡¨ç¤ºäº®åº¦ç™¾åˆ†æ¯”
   */
  defaultBrightness: number = 60
  
  /**
   * é»˜è®¤è‰²æ¸©å€¼
   * èŒƒå›´ï¼š0-100ï¼Œè¡¨ç¤ºè‰²æ¸©ç™¾åˆ†æ¯”
   */
  defaultColorTemperature: number = 60
  
  /**
   * é»˜è®¤é¢œè‰²å€¼
   * RGBæ ¼å¼çš„é¢œè‰²å€¼
   */
  defaultColor: ColorRGB = { r: 255, g: 255, b: 255 }

  // ==================== UIçŠ¶æ€ç®¡ç† ====================
  
  /**
   * å½“å‰äº®åº¦å€¼
   * ç”¨äºæ˜¾ç¤ºå½“å‰è®¾å¤‡çš„äº®åº¦è®¾ç½®
   */
  @State currentBrightness: number = 60
  
  /**
   * å½“å‰è‰²æ¸©å€¼
   * ç”¨äºæ˜¾ç¤ºå½“å‰è®¾å¤‡çš„è‰²æ¸©è®¾ç½®
   */
  @State currentColorTemperature: number = 60
  
  /**
   * å½“å‰è®¾å¤‡ç´¢å¼•
   * ç”¨äºæ ‡è¯†ç”¨æˆ·åœ¨è®¾å¤‡åˆ—è¡¨ä¸­é€‰æ‹©çš„è®¾å¤‡ä½ç½®
   */
  @State deviceIndex: number = 0
  
  /**
   * æ˜¾ç¤ºæ‰¹é‡æ§åˆ¶ç¡®è®¤å¯¹è¯æ¡†
   * trueè¡¨ç¤ºæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
   */
  @State showBulkDialog: boolean = false
  
  /**
   * æ‰¹é‡æ§åˆ¶åŠ¨ä½œ
   * 'on'è¡¨ç¤ºå…¨éƒ¨å¼€å¯ï¼Œ'off'è¡¨ç¤ºå…¨éƒ¨å…³é—­
   */
  @State bulkAction: 'on' | 'off' = 'off'

  // ==================== ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ ====================
  
  /**
   * ç»„ä»¶å³å°†æ˜¾ç¤ºæ—¶çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - åœ¨ç»„ä»¶æ˜¾ç¤ºå‰æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ
   * - åŠ è½½è®¾å¤‡æ•°æ®å¹¶åˆå§‹åŒ–è®¾å¤‡çŠ¶æ€
   */
  aboutToAppear() {
    this.loadDevices()
  }

  // ==================== æ•°æ®åŠ è½½æ–¹æ³• ====================
  
  /**
   * åŠ è½½è®¾å¤‡åˆ—è¡¨
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ä»deviceControlså’Œturnæ•°ç»„æ„å»ºè®¾å¤‡åˆ—è¡¨
   * - åˆå§‹åŒ–è®¾å¤‡çŠ¶æ€æ˜ å°„
   * - è®¾ç½®é»˜è®¤é€‰ä¸­çš„è®¾å¤‡
   */
  async loadDevices() {
    // ä» deviceControls æ„å»ºè®¾å¤‡åˆ—è¡¨ï¼ˆçœŸå®æ§åˆ¶ä½¿ç”¨ HttpUtilï¼‰
    const now: string = new Date().toISOString()

    // ==================== æ„å»ºè®¾å¤‡åˆ—è¡¨ï¼ˆ25ä¸ªè®¾å¤‡ï¼‰ ====================
    this.deviceList = deviceControls.map((dc): LightDevice => ({
      deviceId: dc.control_sub_id,                    // è®¾å¤‡ID
      deviceName: dc.name ?? dc.control_sub_id,      // è®¾å¤‡åç§°
      type: dc.type_uuid,                            // è®¾å¤‡ç±»å‹
      status: (dc.control_sub_state === '0'),        // è®¾å¤‡çŠ¶æ€ï¼ˆ'0'=å¼€å¯ï¼Œ'1'=å…³é—­ï¼‰
      brightness: dc.w_channel ?? this.defaultBrightness,     // äº®åº¦å€¼
      color: this.defaultColor,                       // é¢œè‰²å€¼
      colorTemperature: dc.y_channel ?? this.defaultColorTemperature, // è‰²æ¸©å€¼
      lastUpdateTime: now                             // æœ€åæ›´æ–°æ—¶é—´
    } as LightDevice))
    
    // åˆå§‹åŒ–è®¾å¤‡çŠ¶æ€æ˜ å°„
    this.deviceList.forEach(d => this.deviceStatus.set(d.deviceId, d.status))
    
    // è®¾ç½®é»˜è®¤é€‰ä¸­çš„è®¾å¤‡
    if (this.deviceList.length > 0) {
      this.deviceIndex = 0
      this.selectedDevice = this.deviceList[0].deviceId
      this.currentBrightness = this.deviceList[0].brightness
      this.currentColorTemperature = this.deviceList[0].colorTemperature
    }

    // ==================== æ„å»ºè®¾å¤‡åˆ—è¡¨ï¼ˆ5ä¸ªæ§åˆ¶è®¾å¤‡ï¼‰ ====================
    this.deviceList1 = turn.map((dc): LightDevice => ({
      deviceId: dc.control_sub_id,                    // è®¾å¤‡ID
      deviceName: dc.name ?? dc.control_sub_id,      // è®¾å¤‡åç§°
      type: dc.type_uuid,                            // è®¾å¤‡ç±»å‹
      status: (dc.control_sub_state === '0'),        // è®¾å¤‡çŠ¶æ€
      brightness: dc.w_channel ?? this.defaultBrightness,     // äº®åº¦å€¼
      color: this.defaultColor,                       // é¢œè‰²å€¼
      colorTemperature: dc.y_channel ?? this.defaultColorTemperature, // è‰²æ¸©å€¼
      lastUpdateTime: now                             // æœ€åæ›´æ–°æ—¶é—´
    } as LightDevice))
    
    // åˆå§‹åŒ–æ§åˆ¶è®¾å¤‡çŠ¶æ€æ˜ å°„
    this.deviceList1.forEach(d => this.deviceStatus1.set(d.deviceId, d.status))
    
    // è®¾ç½®é»˜è®¤é€‰ä¸­çš„æ§åˆ¶è®¾å¤‡
    if (this.deviceList1.length > 0) {
      this.deviceIndex = 0
      this.selectedDevice = this.deviceList1[0].deviceId
      this.currentBrightness = this.deviceList1[0].brightness
      this.currentColorTemperature = this.deviceList1[0].colorTemperature
    }
  }

  // ==================== è®¾å¤‡æ§åˆ¶æ–¹æ³• ====================
  
  /**
   * è·å–å½“å‰é€‰ä¸­è®¾å¤‡çš„å¼€å…³çŠ¶æ€
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ä»è®¾å¤‡çŠ¶æ€æ˜ å°„ä¸­è·å–å½“å‰é€‰ä¸­è®¾å¤‡çš„çŠ¶æ€
   * - å¦‚æœè®¾å¤‡ä¸å­˜åœ¨åˆ™è¿”å›false
   * 
   * è¿”å›å€¼ï¼š
   * - boolean - è®¾å¤‡å¼€å…³çŠ¶æ€ï¼Œtrueè¡¨ç¤ºå¼€å¯ï¼Œfalseè¡¨ç¤ºå…³é—­
   */
  getCurrentDeviceStatus(): boolean {
    return this.deviceStatus.get(this.selectedDevice) || false
  }

  /**
   * é€‰æ‹©è®¾å¤‡æ–¹æ³•
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ›´æ–°å½“å‰é€‰ä¸­çš„è®¾å¤‡
   * - åŒæ­¥æ›´æ–°è®¾å¤‡ç´¢å¼•å’Œç›¸å…³çŠ¶æ€
   * 
   * å‚æ•°è¯´æ˜ï¼š
   * - deviceId: string - è¦é€‰æ‹©çš„è®¾å¤‡ID
   */
  private onSelectDevice(deviceId: string) {
    this.selectedDevice = deviceId
    const idx = this.deviceList.findIndex(d => d.deviceId === deviceId)
    if (idx >= 0) {
      this.deviceIndex = idx
      const found = this.deviceList[idx]
      this.currentBrightness = found.brightness
      this.currentColorTemperature = found.colorTemperature
    }
  }

  // ==================== UIæ„å»ºæ–¹æ³• ====================
  
  /**
   * æ„å»ºç¯å…‰æ§åˆ¶é¡µé¢UI
   * 
   * è¿™æ˜¯ArkUIç»„ä»¶çš„æ ¸å¿ƒæ–¹æ³•ï¼Œç”¨äºå®šä¹‰é¡µé¢çš„ç»“æ„å’Œæ ·å¼
   * ä¸»è¦æ„å»ºæ ‡é¢˜ã€è®¾å¤‡é€‰æ‹©ã€çŠ¶æ€æ˜¾ç¤ºã€æ§åˆ¶æŒ‰é’®ç­‰åŒºåŸŸ
   * ä½¿ç”¨NavDestinationåŒ…è£…ç¡®ä¿æ­£ç¡®çš„å¯¼èˆªè¡Œä¸º
   */
  build() {
    // åˆ›å»ºå¯¼èˆªç›®æ ‡å®¹å™¨
    NavDestination() {
      // åˆ›å»ºä¸»åˆ—å®¹å™¨
      Column() {
        
        // ==================== é¡¶éƒ¨å¯¼èˆªæ  ====================
        Row() {
          // å±…ä¸­çš„é¡µé¢æ ‡é¢˜
          Text('ç¯å…‰æ§åˆ¶')
            .fontSize(20)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º20åƒç´ 
            .fontWeight(FontWeight.Bold)     // è®¾ç½®å­—ä½“ç²—ç»†ä¸ºç²—ä½“
            .fontColor('#2c2c2c')            // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºæ·±ç°è‰²
        }
        .width('100%')                       // è®¾ç½®å®½åº¦ä¸º100%
        .justifyContent(FlexAlign.Center)    // å±…ä¸­æ˜¾ç¤º
        .margin({ bottom: 20 })              // è®¾ç½®ä¸‹è¾¹è·ä¸º20åƒç´ 

        // ==================== è®¾å¤‡é€‰æ‹©åŒºåŸŸ ====================
        Column() {
          // åŒºåŸŸæ ‡é¢˜
          Text('é€‰æ‹©è®¾å¤‡')
            .fontSize(16)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º16åƒç´ 
            .fontWeight(FontWeight.Medium)   // è®¾ç½®å­—ä½“ç²—ç»†ä¸ºä¸­ç­‰
            .alignSelf(ItemAlign.Start)      // å·¦å¯¹é½
            .margin({ bottom: 10 })          // è®¾ç½®ä¸‹è¾¹è·ä¸º10åƒç´ 

          // è®¾å¤‡æŒ‰é’®åˆ—è¡¨
          // é¡¶éƒ¨æ©™è‰²è®¾å¤‡å¯¼èˆªå·²ç§»é™¤

          // ==================== è®¾å¤‡åˆ‡æ¢æŒ‰é’® ====================
          // è®¾å¤‡åˆ‡æ¢ï¼šä¸Šä¸€/ä¸‹ä¸€
          Row() {
            // "ä¸Šä¸€è®¾å¤‡"æŒ‰é’®
            Button('ä¸Šä¸€è®¾å¤‡')
              .onClick(() => {
                // æ£€æŸ¥è®¾å¤‡åˆ—è¡¨æ˜¯å¦ä¸ºç©º
                if (this.deviceList.length === 0) { return }
                // è®¡ç®—ä¸Šä¸€ä¸ªè®¾å¤‡çš„ç´¢å¼•ï¼ˆæ”¯æŒå¾ªç¯ï¼‰
                this.deviceIndex = (this.deviceIndex - 1 + this.deviceList.length) % this.deviceList.length
                // é€‰æ‹©ä¸Šä¸€ä¸ªè®¾å¤‡
                this.onSelectDevice(this.deviceList[this.deviceIndex].deviceId)
              })
            
            // ç©ºç™½å ä½ç¬¦
            Blank()
            
            // "ä¸‹ä¸€è®¾å¤‡"æŒ‰é’®
            Button('ä¸‹ä¸€è®¾å¤‡')
              .onClick(() => {
                // æ£€æŸ¥è®¾å¤‡åˆ—è¡¨æ˜¯å¦ä¸ºç©º
                if (this.deviceList.length === 0) { return }
                // è®¡ç®—ä¸‹ä¸€ä¸ªè®¾å¤‡çš„ç´¢å¼•ï¼ˆæ”¯æŒå¾ªç¯ï¼‰
                this.deviceIndex = (this.deviceIndex + 1) % this.deviceList.length
                // é€‰æ‹©ä¸‹ä¸€ä¸ªè®¾å¤‡
                this.onSelectDevice(this.deviceList[this.deviceIndex].deviceId)
              })
          }
          .width('100%')                     // è®¾ç½®å®½åº¦ä¸º100%
          .margin({ top: 12 })                // è®¾ç½®ä¸Šè¾¹è·ä¸º12åƒç´ 

          // ==================== å½“å‰è®¾å¤‡ä¿¡æ¯æ˜¾ç¤º ====================
          Row() {
            // æ˜¾ç¤ºå½“å‰è®¾å¤‡ä½ç½®ä¿¡æ¯ï¼ˆå¦‚ï¼šå½“å‰è®¾å¤‡: 1/25ï¼‰
            Text(`å½“å‰è®¾å¤‡: ${this.deviceIndex + 1}/${this.deviceList.length}`)
              .fontSize(14)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º14åƒç´ 
              .fontColor('#2c2c2c')            // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºæ·±ç°è‰²
            
            // ç©ºç™½å ä½ç¬¦
            Blank()
            
            // æ˜¾ç¤ºå½“å‰è®¾å¤‡çš„åç§°
            Text(this.deviceList[this.deviceIndex]?.deviceName ?? 'æœªå‘½åè®¾å¤‡')
              .fontSize(16)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º16åƒç´ 
              .fontWeight(FontWeight.Medium)   // è®¾ç½®å­—ä½“ç²—ç»†ä¸ºä¸­ç­‰
              .fontColor(Color.Gray)           // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºç°è‰²
          }
          .width('100%')                       // è®¾ç½®å®½åº¦ä¸º100%
          .margin({ top: 8 })                  // è®¾ç½®ä¸Šè¾¹è·ä¸º8åƒç´ 

          // ==================== è®¾å¤‡é€‰æ‹©æ»‘å— ====================
          Row() {
            // è®¾å¤‡ç´¢å¼•æ»‘å—ï¼Œç”¨äºå¿«é€Ÿé€‰æ‹©è®¾å¤‡
            Slider({
              value: this.deviceIndex,                           // å½“å‰å€¼ï¼ˆè®¾å¤‡ç´¢å¼•ï¼‰
              min: 0,                                           // æœ€å°å€¼
              max: Math.max(this.deviceList.length - 1, 0),    // æœ€å¤§å€¼ï¼ˆè®¾å¤‡æ•°é‡-1ï¼‰
              step: 1,                                         // æ­¥é•¿ï¼ˆæ¯æ¬¡ç§»åŠ¨1ä¸ªå•ä½ï¼‰
              style: SliderStyle.OutSet                         // æ»‘å—æ ·å¼ï¼ˆå¤–ç½®æ ·å¼ï¼‰
            })
              .onChange((idx: number) => {
                // æ»‘å—å€¼å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•°
                const i = Math.floor(idx)  // å°†æµ®ç‚¹æ•°è½¬æ¢ä¸ºæ•´æ•°
                // æ£€æŸ¥ç´¢å¼•æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
                if (i >= 0 && i < this.deviceList.length) {
                  this.deviceIndex = i                                    // æ›´æ–°è®¾å¤‡ç´¢å¼•
                  this.onSelectDevice(this.deviceList[i].deviceId)       // é€‰æ‹©å¯¹åº”è®¾å¤‡
                }
              })
          }
          .width('100%')                       // è®¾ç½®å®½åº¦ä¸º100%
          .margin({ top: 8 })                  // è®¾ç½®ä¸Šè¾¹è·ä¸º8åƒç´ 
        }
        .width('100%')                         // è®¾ç½®å®½åº¦ä¸º100%
        .padding(20)                           // è®¾ç½®å†…è¾¹è·ä¸º20åƒç´ 
        .backgroundColor('#FFF')               // ç™½è‰²èƒŒæ™¯å¡ç‰‡
        .borderRadius(20)                      // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º20åƒç´ 
        .margin({ bottom: 20 })                 // è®¾ç½®ä¸‹è¾¹è·ä¸º20åƒç´ 

        // ==================== è®¾å¤‡çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ ====================
        Column() {
          // åŒºåŸŸæ ‡é¢˜
          Text('è®¾å¤‡çŠ¶æ€')
            .fontSize(16)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º16åƒç´ 
            .fontWeight(FontWeight.Medium)   // è®¾ç½®å­—ä½“ç²—ç»†ä¸ºä¸­ç­‰
            .alignSelf(ItemAlign.Start)      // å·¦å¯¹é½
            .margin({ bottom: 15 })          // è®¾ç½®ä¸‹è¾¹è·ä¸º15åƒç´ 

          // ==================== çŠ¶æ€æ˜¾ç¤ºå¡ç‰‡ ====================
          Row() {
            // çŠ¶æ€å›¾æ ‡
            Column() {
              if (this.getCurrentDeviceStatus()) {
                // å¼€å¯çŠ¶æ€
                Text('ğŸ’¡')  // ç¯æ³¡å›¾æ ‡
                  .fontSize(40)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º40åƒç´ 
                  .fontColor('#07C160')            // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºç»¿è‰²
              } else {
                // å…³é—­çŠ¶æ€
                Text('ğŸ”Œ')  // æ’å¤´å›¾æ ‡
                  .fontSize(40)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º40åƒç´ 
                  .fontColor('#999999')            // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºç°è‰²
              }
            }
            .width(80)                         // è®¾ç½®å®½åº¦ä¸º80åƒç´ 
            .justifyContent(FlexAlign.Center)   // å‚ç›´å±…ä¸­å¯¹é½

            // çŠ¶æ€æ–‡æœ¬
            Column() {
              // çŠ¶æ€æè¿°æ–‡æœ¬
              Text(this.getCurrentDeviceStatus() ? 'ç¯å…‰å·²å¼€å¯' : 'ç¯å…‰å·²å…³é—­')
                .fontSize(18)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º18åƒç´ 
                .fontWeight(FontWeight.Medium)   // è®¾ç½®å­—ä½“ç²—ç»†ä¸ºä¸­ç­‰
                .fontColor('#2c2c2c')            // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºæ·±ç°è‰²
              
              // çŠ¶æ€è¯¦æƒ…æ–‡æœ¬
              Text(this.getCurrentDeviceStatus() ? 'è®¾å¤‡æ­£åœ¨è¿è¡Œä¸­' : 'è®¾å¤‡å·²å…³é—­')
                .fontSize(14)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º14åƒç´ 
                .fontColor('#666666')            // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºç°è‰²
                .margin({ top: 5 })               // è®¾ç½®ä¸Šè¾¹è·ä¸º5åƒç´ 
            }
            .layoutWeight(1)                    // è®¾ç½®å¸ƒå±€æƒé‡ä¸º1
            .justifyContent(FlexAlign.Center)    // å‚ç›´å±…ä¸­å¯¹é½
          }
          .width('100%')                         // è®¾ç½®å®½åº¦ä¸º100%
          .padding(20)                           // è®¾ç½®å†…è¾¹è·ä¸º20åƒç´ 
          .backgroundColor(this.getCurrentDeviceStatus() ? '#F0F9FF' : '#F5F5F5')  // æ ¹æ®çŠ¶æ€è®¾ç½®èƒŒæ™¯è‰²
          .borderRadius(15)                      // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º15åƒç´ 
        }
        .width('100%')                           // è®¾ç½®å®½åº¦ä¸º100%
        .padding(20)                             // è®¾ç½®å†…è¾¹è·ä¸º20åƒç´ 
        .backgroundColor(Color.White)             // è®¾ç½®èƒŒæ™¯è‰²ä¸ºç™½è‰²
        .borderRadius(20)                        // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º20åƒç´ 
        .margin({ bottom: 20 })                   // è®¾ç½®ä¸‹è¾¹è·ä¸º20åƒç´ 

        // ï¼ˆæ»‘å—è°ƒèŠ‚äº®åº¦/è‰²æ¸©å·²æŒ‰éœ€æ±‚ç§»é™¤ï¼Œä»…ä¿ç•™è®¾å¤‡é€‰æ‹©æ»‘å—ä¸å¼€å…³æ§åˆ¶ï¼‰

        // ==================== æ§åˆ¶æŒ‰é’®åŒºåŸŸ ====================
        Column() {
          // åŒºåŸŸæ ‡é¢˜
          Text('ç¯å…‰æ§åˆ¶')
            .fontSize(16)                    // è®¾ç½®å­—ä½“å¤§å°ä¸º16åƒç´ 
            .fontWeight(FontWeight.Medium)   // è®¾ç½®å­—ä½“ç²—ç»†ä¸ºä¸­ç­‰
            .alignSelf(ItemAlign.Start)      // å·¦å¯¹é½
            .margin({ bottom: 15 })          // è®¾ç½®ä¸‹è¾¹è·ä¸º15åƒç´ 

          // ==================== å•ä¸ªè®¾å¤‡æ§åˆ¶æŒ‰é’® ====================
          // æ§åˆ¶æŒ‰é’®
          Button(this.getCurrentDeviceStatus() ? 'å…³é—­ç¯å…‰' : 'å¼€å¯ç¯å…‰')
            .width('100%')                       // è®¾ç½®å®½åº¦ä¸º100%
            .height(60)                          // è®¾ç½®é«˜åº¦ä¸º60åƒç´ 
            .fontSize(18)                        // è®¾ç½®å­—ä½“å¤§å°ä¸º18åƒç´ 
            .fontWeight(FontWeight.Medium)       // è®¾ç½®å­—ä½“ç²—ç»†ä¸ºä¸­ç­‰
            .fontColor(Color.White)              // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºç™½è‰²
            .backgroundColor(this.getCurrentDeviceStatus() ? '#FF6B6B' : '#07C160')  // æ ¹æ®çŠ¶æ€è®¾ç½®èƒŒæ™¯è‰²
            .borderRadius(15)                    // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º15åƒç´ 
            .onClick(() => {
              // æ§åˆ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
              if (this.getCurrentDeviceStatus()) {
                // å¦‚æœå½“å‰å·²å¼€å¯ï¼Œåˆ™å…³é—­ç¯å…‰
                this.turnOffLight()
              } else {
                // å¦‚æœå½“å‰å·²å…³é—­ï¼Œåˆ™å¼€å¯ç¯å…‰
                this.turnOnLight()
              }
            })

          // ==================== æ‰¹é‡æ§åˆ¶æŒ‰é’® ====================
          // æ‰¹é‡æ§åˆ¶ï¼šå…¨éƒ¨å¼€å¯ / å…¨éƒ¨å…³é—­ï¼ˆå¸¦ç¡®è®¤å¼¹çª—ï¼‰
          Row({ space: 12 }) {
            // "å…¨éƒ¨å¼€å¯"æŒ‰é’®
            Button('å…¨éƒ¨å¼€å¯')
              .layoutWeight(1)                   // è®¾ç½®å¸ƒå±€æƒé‡ä¸º1
              .height(50)                         // è®¾ç½®é«˜åº¦ä¸º50åƒç´ 
              .fontSize(16)                       // è®¾ç½®å­—ä½“å¤§å°ä¸º16åƒç´ 
              .fontColor(Color.White)             // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºç™½è‰²
              .backgroundColor('#07C160')         // è®¾ç½®èƒŒæ™¯è‰²ä¸ºç»¿è‰²
              .borderRadius(12)                   // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º12åƒç´ 
              .onClick(() => {
                // å…¨éƒ¨å¼€å¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
                this.bulkAction = 'on'             // è®¾ç½®æ‰¹é‡åŠ¨ä½œä¸ºå¼€å¯
                this.showBulkDialog = true         // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
              })

            // "å…¨éƒ¨å…³é—­"æŒ‰é’®
            Button('å…¨éƒ¨å…³é—­')
              .layoutWeight(1)                   // è®¾ç½®å¸ƒå±€æƒé‡ä¸º1
              .height(50)                         // è®¾ç½®é«˜åº¦ä¸º50åƒç´ 
              .fontSize(16)                       // è®¾ç½®å­—ä½“å¤§å°ä¸º16åƒç´ 
              .fontColor(Color.White)             // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºç™½è‰²
              .backgroundColor('#FF6B6B')          // è®¾ç½®èƒŒæ™¯è‰²ä¸ºçº¢è‰²
              .borderRadius(12)                   // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º12åƒç´ 
              .onClick(() => {
                // å…¨éƒ¨å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
                this.bulkAction = 'off'            // è®¾ç½®æ‰¹é‡åŠ¨ä½œä¸ºå…³é—­
                this.showBulkDialog = true        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
              })
          }
          .width('100%')                         // è®¾ç½®å®½åº¦ä¸º100%
          .margin({ top: 12 })                   // è®¾ç½®ä¸Šè¾¹è·ä¸º12åƒç´ 
        }
        .width('100%')                           // è®¾ç½®å®½åº¦ä¸º100%
        .padding(20)                             // è®¾ç½®å†…è¾¹è·ä¸º20åƒç´ 
        .backgroundColor(Color.White)             // è®¾ç½®èƒŒæ™¯è‰²ä¸ºç™½è‰²
        .borderRadius(20)                        // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º20åƒç´ 

      }
      .width('100%')                             // è®¾ç½®å®½åº¦ä¸º100%
      .height('100%')                            // è®¾ç½®é«˜åº¦ä¸º100%
      .padding(20)                               // è®¾ç½®å†…è¾¹è·ä¸º20åƒç´ 
      
      // ==================== æ‰¹é‡æ§åˆ¶ç¡®è®¤å¯¹è¯æ¡† ====================
      if (this.showBulkDialog) {
        Column() {
          Column() {
            // å¯¹è¯æ¡†æ ‡é¢˜
            Text(this.bulkAction === 'on' ? 'ç¡®è®¤å…¨éƒ¨å¼€å¯ï¼Ÿ' : 'ç¡®è®¤å…¨éƒ¨å…³é—­ï¼Ÿ')
              .fontSize(18)                        // è®¾ç½®å­—ä½“å¤§å°ä¸º18åƒç´ 
              .fontWeight(FontWeight.Bold)         // è®¾ç½®å­—ä½“ç²—ç»†ä¸ºç²—ä½“
              .fontColor('#2c2c2c')                // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºæ·±ç°è‰²
              .margin({ bottom: 12 })               // è®¾ç½®ä¸‹è¾¹è·ä¸º12åƒç´ 

            // ç¡®è®¤æ¶ˆæ¯
            Text('è¯·ç¡®è®¤æ˜¯å¦æ‰§è¡Œè¯¥æ‰¹é‡æ“ä½œ')
              .fontSize(14)                        // è®¾ç½®å­—ä½“å¤§å°ä¸º14åƒç´ 
              .fontColor('#666')                   // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºç°è‰²
              .textAlign(TextAlign.Center)         // è®¾ç½®æ–‡æœ¬å±…ä¸­å¯¹é½
              .margin({ bottom: 18 })               // è®¾ç½®ä¸‹è¾¹è·ä¸º18åƒç´ 

            // ==================== æ“ä½œæŒ‰é’® ====================
            Row({ space: 12 }) {
              // å–æ¶ˆæŒ‰é’®
              Button('å–æ¶ˆ')
                .layoutWeight(1)                   // è®¾ç½®å¸ƒå±€æƒé‡ä¸º1
                .height(42)                         // è®¾ç½®é«˜åº¦ä¸º42åƒç´ 
                .backgroundColor('#F0F0F0')         // è®¾ç½®èƒŒæ™¯è‰²ä¸ºæµ…ç°è‰²
                .fontColor(Color.Black)              // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºé»‘è‰²
                .borderRadius(12)                   // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º12åƒç´ 
                .onClick(() => {
                  // å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
                  this.showBulkDialog = false      // å…³é—­å¯¹è¯æ¡†
                })

              // ç¡®è®¤æŒ‰é’®
              Button('ç¡®è®¤')
                .layoutWeight(1)                   // è®¾ç½®å¸ƒå±€æƒé‡ä¸º1
                .height(42)                         // è®¾ç½®é«˜åº¦ä¸º42åƒç´ 
                .backgroundColor('#e16531')         // è®¾ç½®èƒŒæ™¯è‰²ä¸ºä¸»é¢˜æ©™è‰²
                .fontColor(Color.White)              // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºç™½è‰²
                .borderRadius(12)                   // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º12åƒç´ 
                .onClick(async () => {
                  // ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
                  this.showBulkDialog = false      // å…³é—­å¯¹è¯æ¡†
                  if (this.bulkAction === 'on') {
                    // å¦‚æœé€‰æ‹©å¼€å¯ï¼Œåˆ™æ‰§è¡Œå…¨éƒ¨å¼€å¯
                    await this.turnOnAll()
                  } else {
                    // å¦‚æœé€‰æ‹©å…³é—­ï¼Œåˆ™æ‰§è¡Œå…¨éƒ¨å…³é—­
                    await this.turnOffAll()
                  }
                })
            }
          }
          .width('80%')                            // è®¾ç½®å¯¹è¯æ¡†å®½åº¦ä¸º80%
          .padding(20)                             // è®¾ç½®å†…è¾¹è·ä¸º20åƒç´ 
          .backgroundColor(Color.White)             // è®¾ç½®èƒŒæ™¯è‰²ä¸ºç™½è‰²
          .borderRadius(16)                        // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼ŒåŠå¾„ä¸º16åƒç´ 
          .shadow({ radius: 20, color: '#1A000000', offsetX: 0, offsetY: 5 })  // æ·»åŠ é˜´å½±æ•ˆæœ
        }
        .width('100%')                             // è®¾ç½®å®½åº¦ä¸º100%
        .height('100%')                            // è®¾ç½®é«˜åº¦ä¸º100%
        .justifyContent(FlexAlign.Center)          // å‚ç›´å±…ä¸­å¯¹é½
        .backgroundColor('#80000000')               // è®¾ç½®åŠé€æ˜é»‘è‰²èƒŒæ™¯
        .position({ x: 0, y: 0 })                  // è¦†ç›–æ•´ä¸ªé¡µé¢
      }
    }
    .onReady((context: NavDestinationContext) => {
      // å¯¼èˆªç›®æ ‡å‡†å¤‡å°±ç»ªæ—¶çš„å›è°ƒå‡½æ•°
      this.pathStack = context.pathStack;  // è·å–å¯¼èˆªæ ˆä¸Šä¸‹æ–‡
    })
    .backgroundColor('#F2F8FB')                   // é¡µé¢èƒŒæ™¯è‰²
  }

  // ==================== è®¾å¤‡æ§åˆ¶æ–¹æ³• ====================
  
  /**
   * æ‰“å¼€é€‰ä¸­è®¾å¤‡çš„ç¯å…‰
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - è°ƒç”¨HTTPå·¥å…·ç±»å¼€å¯æŒ‡å®šè®¾å¤‡
   * - æ›´æ–°æœ¬åœ°è®¾å¤‡çŠ¶æ€
   * - è§¦å‘UIæ›´æ–°
   */
  private async turnOnLight() {
    try {
      // çœŸå®æ¥å£ï¼šstate '0' è¡¨ç¤ºæ‰“å¼€
      await HttpUtil.getInstance().setLightBrightness(
        `${this.URL}${this.url2}`,
        this.defaultBrightness,
        this.defaultColorTemperature,
        '0',
        this.selectedDevice
      )
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      this.deviceStatus.set(this.selectedDevice, true)
      // è§¦å‘UIæ›´æ–°
      this.deviceStatus = new Map(this.deviceStatus)
    } catch (error) {
      console.error('æ‰“å¼€ç¯å…‰å¤±è´¥:', error)
    }
  }

  /**
   * å…³é—­é€‰ä¸­è®¾å¤‡çš„ç¯å…‰
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - è°ƒç”¨HTTPå·¥å…·ç±»å…³é—­æŒ‡å®šè®¾å¤‡
   * - æ›´æ–°æœ¬åœ°è®¾å¤‡çŠ¶æ€
   * - è§¦å‘UIæ›´æ–°
   */
  private async turnOffLight() {
    try {
      // çœŸå®æ¥å£ï¼šstate '1' è¡¨ç¤ºå…³é—­
      await HttpUtil.getInstance().setLightBrightness(
        `${this.URL}${this.url2}`,
        this.defaultBrightness,
        this.defaultColorTemperature,
        '1',
        this.selectedDevice
      )
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      this.deviceStatus.set(this.selectedDevice, false)
      // è§¦å‘UIæ›´æ–°
      this.deviceStatus = new Map(this.deviceStatus)
    } catch (error) {
      console.error('å…³é—­ç¯å…‰å¤±è´¥:', error)
    }
  }

  /**
   * æ‰¹é‡å¼€å¯æ‰€æœ‰è®¾å¤‡
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ä½¿ç”¨5ä¸ªè®¾å¤‡æ¥å£æ§åˆ¶å…¨éƒ¨25ä¸ªè®¾å¤‡
   * - éå†æ§åˆ¶è®¾å¤‡åˆ—è¡¨ï¼Œé€ä¸ªå¼€å¯è®¾å¤‡
   * - æ›´æ–°æœ¬åœ°è®¾å¤‡çŠ¶æ€
   */
  private async turnOnAll() {
    try {
      // éå†5ä¸ªæ§åˆ¶è®¾å¤‡
      for (const d of this.deviceList1) {
        // è°ƒç”¨HTTPå·¥å…·ç±»å¼€å¯è®¾å¤‡
        await HttpUtil.getInstance().setLightBrightness(
          `${this.URL}${this.url2}`,
          this.defaultBrightness,
          this.defaultColorTemperature,
          '0',  // '0'è¡¨ç¤ºå¼€å¯
          d.deviceId
        )
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        this.deviceStatus1.set(d.deviceId, true)
      }
      // è§¦å‘UIæ›´æ–°
      this.deviceStatus1 = new Map(this.deviceStatus1)
    } catch (e) {
      console.error('æ‰¹é‡å¼€å¯å¤±è´¥:', e)
    }
  }

  /**
   * æ‰¹é‡å…³é—­æ‰€æœ‰è®¾å¤‡
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ä½¿ç”¨5ä¸ªè®¾å¤‡æ¥å£æ§åˆ¶å…¨éƒ¨25ä¸ªè®¾å¤‡
   * - éå†æ§åˆ¶è®¾å¤‡åˆ—è¡¨ï¼Œé€ä¸ªå…³é—­è®¾å¤‡
   * - æ›´æ–°æœ¬åœ°è®¾å¤‡çŠ¶æ€
   */
  private async turnOffAll() {
    try {
      // éå†5ä¸ªæ§åˆ¶è®¾å¤‡
      for (const d of this.deviceList1) {
        // è°ƒç”¨HTTPå·¥å…·ç±»å…³é—­è®¾å¤‡
        await HttpUtil.getInstance().setLightBrightness(
          `${this.URL}${this.url2}`,
          this.defaultBrightness,
          this.defaultColorTemperature,
          '1',  // '1'è¡¨ç¤ºå…³é—­
          d.deviceId
        )
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        this.deviceStatus1.set(d.deviceId, false)
      }
      // è§¦å‘UIæ›´æ–°
      this.deviceStatus1 = new Map(this.deviceStatus1)
    } catch (e) {
      console.error('æ‰¹é‡å…³é—­å¤±è´¥:', e)
    }
  }
}